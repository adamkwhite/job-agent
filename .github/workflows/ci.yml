name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers

# Cancel in-progress runs when a new push arrives on the same branch/PR.
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Pre-commit Checks (Ruff, Formatting)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-

      - name: Run pre-commit checks
        run: pre-commit run --all-files --show-diff-on-failure
        env:
          SKIP: sonarlint  # Local-only tool; scan.sh not available on CI runners

  test:
    name: Test with pytest
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest>=8.0.0 pytest-cov>=6.0.0 pytest-html>=4.1.0 pytest-mock>=3.12.0
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run tests with coverage
        env:
          DATABASE_PATH: /tmp/ci_test_jobs.db
        run: |
          # Check if tests exist
          if find tests/ -name "test_*.py" -type f | grep -q .; then
            PYTHONPATH=$PWD pytest tests/ \
              --cov=src \
              --cov-report=term-missing:skip-covered \
              --cov-report=xml \
              --cov-report=html \
              --html=test-report.html \
              --self-contained-html \
              -v
          else
            echo "âš ï¸  No test files found - tests need to be written"
            echo "Skipping test execution"
          fi

      - name: Verify production DB not touched
        run: |
          if [ -f data/jobs.db ]; then
            # Check if production database was modified in last 5 minutes
            MODIFIED=$(stat -c %Y data/jobs.db)
            START_TIME=$(date -d '5 minutes ago' +%s)
            if [ $MODIFIED -gt $START_TIME ]; then
              echo "âŒ ERROR: Production database (data/jobs.db) was modified during tests!"
              echo "Tests should use DATABASE_PATH environment variable for isolation."
              echo "Modified timestamp: $(date -d @$MODIFIED)"
              exit 1
            else
              echo "âœ… Production database not modified during tests"
            fi
          else
            echo "âœ… Production database does not exist (expected for clean CI environment)"
          fi

      - name: Upload coverage to artifacts
        if: hashFiles('htmlcov/**') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

      - name: Upload test report to artifacts
        if: hashFiles('test-report.html') != ''
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.html
          retention-days: 30

      - name: Coverage summary
        if: hashFiles('.coverage') != ''
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          coverage report >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage to Codecov
        if: hashFiles('coverage.xml') != ''
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage threshold
        if: hashFiles('.coverage') != ''
        run: |
          echo "ðŸ“Š Checking coverage meets minimum threshold..."
          echo ""

          # Get overall coverage percentage
          COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          echo "Overall coverage: ${COVERAGE}%"

          # Note: We don't fail on overall coverage since legacy code has low coverage
          # SonarCloud enforces 80% coverage on NEW code only

          echo ""
          echo "âœ… Coverage check complete. SonarCloud will enforce 80% on new code."
